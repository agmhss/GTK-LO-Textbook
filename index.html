<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Learning Outcomes ↔ Textbook Connector</title>
  
  <!-- PDF.js stable version from cdnjs (v2.11.338, exposes pdfjsLib globally) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  
  <!-- Tesseract.js v5 -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0; padding: 16px; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    }
    .wrap {
      max-width: 900px; margin: 0 auto; background: #fff; border-radius: 16px;
      padding: 16px; box-shadow: 0 12px 30px rgba(0,0,0,.15);
    }
    h1 { text-align:center; margin-top: 4px; font-size: 1.4rem; }
    .block { border:1px dashed #ccd; border-radius:12px; padding:12px; margin-top:12px; }
    label { font-weight:600; font-size:.9rem; }
    input, select {
      width:100%; padding:8px 10px; margin-top:6px;
      border-radius:10px; border:1px solid #ccd; font-size:.9rem;
    }
    .row{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
    .row input{flex:1;min-width:90px;}
    button{
      width:100%; margin-top:10px; padding:10px 14px; border-radius:12px;
      border:none; font-weight:600; font-size:.95rem; color:#fff;
      background:linear-gradient(45deg,#667eea,#764ba2); cursor: pointer;
    }
    button:disabled{ background: #ccc !important; cursor: not-allowed; opacity: 0.7; }
    .btn-group { display: flex; gap: 10px; margin-top: 12px; }
    .download-btn { background: #10b981; flex: 1; }
    .copy-btn { background: #3b82f6; flex: 1; }
    .status{margin-top:8px;padding:8px;border-radius:8px;font-size:.85rem;}
    .ok{background:#e6ffed;color:#03543f;border:1px solid #a7f3d0;}
    .err{background:#fde8e8;color:#9b1c1c;border:1px solid #fecaca;}
    .lib-status { font-size: 0.75rem; text-align: center; margin-bottom: 10px; padding: 5px; border-radius: 5px; }
    #output{margin-top:16px;}
    .card{ background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%); color:#fff;padding:12px;border-radius:12px;margin-bottom:10px; }
    .match{background:#fff;color:#123;padding:10px;border-radius:10px;margin-top:8px;}
    .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s infinite; margin-right: 8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Learning Outcomes ↔ Textbook Connector</h1>
  
  <div id="libIndicator" class="lib-status" style="background: #fffbeb; color: #d97706;">
    ⌛ Checking Engines (PDF & OCR)...
  </div>

  <div class="block">
    <label>Groq API key</label>
    <input type="password" id="apiKey" placeholder="gsk_xxxx" />
  </div>

  <div class="block">
    <label>Target Language</label>
    <select id="outputLang">
      <option value="English">English</option>
      <option value="Tamil">Tamil (தமிழ்)</option>
    </select>
  </div>

  <div class="block">
    <label>Learning outcomes PDF</label>
    <input type="file" id="outPdf" accept="application/pdf" />
    <div class="row">
      <input type="number" id="outStart" placeholder="Start page (optional)" min="1" />
      <input type="number" id="outEnd" placeholder="End page (optional)" min="1" />
    </div>
    <button type="button" id="outBtn">Extract outcomes</button>
    <div id="outStatus"></div>
  </div>

  <div class="block">
    <label>Textbook PDF</label>
    <input type="file" id="tbPdf" accept="application/pdf" />
    <div class="row">
      <input type="number" id="tbStart" placeholder="Start page (optional)" min="1" />
      <input type="number" id="tbEnd" placeholder="End page (optional)" min="1" />
    </div>
    <button type="button" id="tbBtn">Extract textbook</button>
    <div id="tbStatus"></div>
  </div>

  <button id="analyzeBtn" type="button" disabled>Analyze & Build Lesson Plan</button>
  <div id="output"></div>
</div>

<script>
let outcomesText = "";
let textbookText = "";
let lastAnalysis = null;
let tesseractWorker = null; // Shared worker for all OCR

// Library readiness check
async function checkLibraries() {
  const indicator = document.getElementById('libIndicator');
  
  const pdfReady = typeof pdfjsLib !== 'undefined';
  const tesseractReady = typeof Tesseract !== 'undefined';

  if (pdfReady && tesseractReady) {
    // Set PDF worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
    
    // Create shared Tesseract worker
    tesseractWorker = await Tesseract.createWorker({
      logger: m => console.log(m) // Optional logging
    });
    
    indicator.innerText = "✅ PDF.js & Tesseract.js Ready";
    indicator.style.background = "#ecfdf5";
    indicator.style.color = "#059669";
    
    document.getElementById('outBtn').disabled = false;
    document.getElementById('tbBtn').disabled = false;
  } else {
    let missing = [];
    if (!pdfReady) missing.push("PDF.js");
    if (!tesseractReady) missing.push("Tesseract.js");
    indicator.innerText = "⌛ Waiting for: " + missing.join(" & ");
    setTimeout(checkLibraries, 500);
  }
}

window.addEventListener('load', checkLibraries);

function setStatus(elId, msg, ok = true, loading = false) {
  const el = document.getElementById(elId);
  const spin = loading ? '<span class="spinner"></span>' : '';
  el.innerHTML = `<div class="status ${ok ? 'ok' : 'err'}">${spin}${msg}</div>`;
}

async function performImageOCR(page) {
  if (!tesseractWorker) throw new Error("Tesseract worker not ready");

  const langCode = document.getElementById("outputLang").value === "Tamil" ? "tam+eng" : "eng";
  
  // Load/init language if not already done (idempotent)
  await tesseractWorker.loadLanguage(langCode);
  await tesseractWorker.initialize(langCode);
  
  const viewport = page.getViewport({ scale: 2.0 });
  const canvas = document.createElement('canvas');
  const context = canvas.getContext('2d');
  canvas.height = viewport.height;
  canvas.width = viewport.width;

  const renderContext = {
    canvasContext: context,
    viewport: viewport
  };
  await page.render(renderContext).promise;

  const { data: { text } } = await tesseractWorker.recognize(canvas);
  return text.trim();
}

async function extractRangeFromPdf(file, startInput, endInput, statusId) {
  const buf = await file.arrayBuffer();
  const loadingTask = pdfjsLib.getDocument({ data: buf });
  const pdf = await loadingTask.promise;
  
  let from = 1;
  let to = pdf.numPages;
  
  if (startInput.value) from = Math.max(1, parseInt(startInput.value) || 1);
  if (endInput.value) to = Math.min(pdf.numPages, parseInt(endInput.value) || pdf.numPages);
  if (from > to) [from, to] = [to, from];
  
  let allText = "";

  for (let p = from; p <= to; p++) {
    setStatus(statusId, `OCR on page ${p}/${to}...`, true, true);
    const page = await pdf.getPage(p);
    const pageText = await performImageOCR(page);
    allText += `\n\n[Page ${p}]\n${pageText}`;
  }
  
  return allText.trim();
}

async function extractOutcomes() {
  const file = document.getElementById("outPdf").files[0];
  if (!file) return setStatus("outStatus", "Please select a PDF file", false);
  
  document.getElementById("outBtn").disabled = true;
  try {
    outcomesText = await extractRangeFromPdf(file, document.getElementById("outStart"), document.getElementById("outEnd"), "outStatus");
    setStatus("outStatus", `Extracted ${outcomesText.length.toLocaleString()} characters.`, true);
    enableAnalyze();
  } catch (e) {
    setStatus("outStatus", "Error: " + e.message, false);
    console.error(e);
  } finally {
    document.getElementById("outBtn").disabled = false;
  }
}

async function extractTextbook() {
  const file = document.getElementById("tbPdf").files[0];
  if (!file) return setStatus("tbStatus", "Please select a PDF file", false);
  
  document.getElementById("tbBtn").disabled = true;
  try {
    textbookText = await extractRangeFromPdf(file, document.getElementById("tbStart"), document.getElementById("tbEnd"), "tbStatus");
    setStatus("tbStatus", `Extracted ${textbookText.length.toLocaleString()} characters.`, true);
    enableAnalyze();
  } catch (e) {
    setStatus("tbStatus", "Error: " + e.message, false);
    console.error(e);
  } finally {
    document.getElementById("tbBtn").disabled = false;
  }
}

function enableAnalyze() {
  const key = document.getElementById("apiKey").value.trim();
  document.getElementById("analyzeBtn").disabled = !(key && outcomesText && textbookText);
}

document.getElementById("apiKey").addEventListener("input", enableAnalyze);
document.getElementById("analyzeBtn").addEventListener("click", analyze);
document.getElementById("outBtn").addEventListener("click", extractOutcomes);
document.getElementById("tbBtn").addEventListener("click", extractTextbook);

async function analyze() {
  const key = document.getElementById("apiKey").value.trim();
  const lang = document.getElementById("outputLang").value;
  
  if (!key || !outcomesText || !textbookText) return;
  
  setStatus("output", "AI analyzing and matching outcomes...", true, true);
  document.getElementById("analyzeBtn").disabled = true;

  const outcomesSnippet = outcomesText.slice(0, 8000);
  const textbookSnippet = textbookText.slice(0, 12000);

  const prompt = `You are an expert educator. Output ONLY a valid JSON object (no extra text).

Analyze the provided learning outcomes and textbook content. Identify up to 8 strong matches between outcomes and relevant textbook sections.

Respond in ${lang}.

JSON structure:
{
  "subject": "Subject name",
  "class": "Class/Grade",
  "lessonTopic": "Main topic",
  "learningOutcomes": [
    {
      "outcome": "Full outcome text",
      "smartObjectives": ["Objective 1", "Objective 2", ...],
      "activities": ["Activity 1", "Activity 2", ...],
      "assessment": "Assessment method"
    },
    ...
  ],
  "lessonPlan": {
    "procedure": ["Step 1", "Step 2", ...]
  }
}

Learning Outcomes (truncated):\n${outcomesSnippet}

Textbook Content (truncated):\n${textbookSnippet}`;

  try {
    const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + key,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "llama-3.3-70b-versatile",
        messages: [{ role: "user", content: prompt }],
        response_format: { type: "json_object" },
        temperature: 0.7,
        max_tokens: 4096
      })
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error?.message || "API error");
    }

    const data = await res.json();
    const content = data.choices[0].message.content;
    lastAnalysis = JSON.parse(content);
    renderResult(lastAnalysis);
  } catch (err) {
    setStatus("output", "Analysis failed: " + err.message, false);
    console.error(err);
  } finally {
    document.getElementById("analyzeBtn").disabled = false;
  }
}

function renderResult(d) {
  let html = `<div class="card"><strong>${d.subject || "Subject"}</strong> - ${d.class || "Class"}<br>Topic: ${d.lessonTopic || "N/A"}</div>`;
  
  if (d.learningOutcomes && d.learningOutcomes.length > 0) {
    d.learningOutcomes.forEach((o, i) => {
      html += `<div class="match">
        <h4>${i + 1}. ${o.outcome || "Outcome"}</h4>
        <p><strong>SMART Objectives:</strong> ${Array.isArray(o.smartObjectives) ? o.smartObjectives.join("; ") : "N/A"}</p>
        <p><strong>Activities:</strong> ${Array.isArray(o.activities) ? o.activities.join("; ") : "N/A"}</p>
        <p><strong>Assessment:</strong> ${o.assessment || "N/A"}</p>
      </div>`;
    });
  } else {
    html += `<div class="match">No outcomes matched.</div>`;
  }

  if (d.lessonPlan?.procedure) {
    html += `<div class="match"><strong>Lesson Procedure:</strong><ol><li>${d.lessonPlan.procedure.join('</li><li>')}</li></ol></div>`;
  }

  html += `<div class="btn-group">
    <button class="download-btn" onclick="downloadText()">Download TXT</button>
    <button class="copy-btn" onclick="copyToClipboard()">Copy All</button>
  </div>`;

  document.getElementById("output").innerHTML = html;
}

function downloadText() {
  if (!lastAnalysis) return;
  const content = `Subject: ${lastAnalysis.subject || ""} - ${lastAnalysis.class || ""}\nTopic: ${lastAnalysis.lessonTopic || ""}\n\nLesson Procedure:\n${(lastAnalysis.lessonPlan?.procedure || []).join('\n')}`;
  const blob = new Blob(['\ufeff' + content], { type: 'text/plain;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'lesson-plan.txt';
  a.click();
}

async function copyToClipboard() {
  if (!lastAnalysis) return;
  const content = `Subject: ${lastAnalysis.subject || ""} - ${lastAnalysis.class || ""}\nTopic: ${lastAnalysis.lessonTopic || ""}\n\nLesson Procedure:\n${(lastAnalysis.lessonPlan?.procedure || []).join('\n')}`;
  await navigator.clipboard.writeText(content);
  alert("Copied to clipboard!");
}

// Optional: terminate worker on page unload to free memory
window.addEventListener('unload', async () => {
  if (tesseractWorker) await tesseractWorker.terminate();
});
</script>
</body>
      </html>
