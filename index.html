<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Learning Outcomes ↔ Textbook Connector</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.393/pdf.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0; padding: 16px;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    }
    .wrap {
      max-width: 900px; margin: 0 auto;
      background: #fff; border-radius: 16px;
      padding: 16px; box-shadow: 0 12px 30px rgba(0,0,0,.15);
    }
    h1 { text-align:center; margin-top: 4px; font-size: 1.4rem; }
    .block { border:1px dashed #ccd; border-radius:12px; padding:12px; margin-top:12px; }
    label { font-weight:600; font-size:.9rem; }
    input[type="file"],input[type="password"],input[type="number"]{
      width:100%; padding:8px 10px; margin-top:6px;
      border-radius:10px; border:1px solid #ccd; font-size:.9rem;
    }
    .row{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
    .row input[type="number"]{flex:1;min-width:90px;}
    button{
      width:100%; margin-top:10px;
      padding:10px 14px; border-radius:12px;
      border:none; font-weight:600; font-size:.95rem;
      color:#fff; background:linear-gradient(45deg,#667eea,#764ba2);
    }
    button:disabled{opacity:.5;}
    .status{margin-top:8px;padding:8px;border-radius:8px;font-size:.85rem;}
    .ok{background:#e6ffed;color:#03543f;border:1px solid #a7f3d0;}
    .err{background:#fde8e8;color:#9b1c1c;border:1px solid #fecaca;}
    #output{margin-top:16px;}
    .card{
      background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);
      color:#fff;padding:12px;border-radius:12px;margin-bottom:10px;
    }
    .match{background:#fff;color:#123;padding:10px;border-radius:10px;margin-top:8px;}
    .match h4{margin:0 0 4px 0;font-size:.95rem;}
    .obj{background:#eef6ff;border-left:4px solid #667eea;border-radius:8px;padding:6px 8px;margin-top:4px;}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Learning Outcomes ↔ Textbook Connector</h1>

  <!-- API key -->
  <div class="block">
    <label>Groq API key (gsk‑…)</label>
    <input type="password" id="apiKey" placeholder="gsk_xxxx" />
  </div>

  <!-- Outcomes PDF -->
  <div class="block">
    <label>Learning outcomes PDF</label>
    <input type="file" id="outPdf" accept="application/pdf" />
    <div class="row">
      <input type="number" id="outStart" placeholder="Start page" min="1" />
      <input type="number" id="outEnd" placeholder="End page" min="1" />
    </div>
    <button type="button" onclick="extractOutcomes()">Extract outcomes text</button>
    <div id="outStatus"></div>
  </div>

  <!-- Textbook PDF -->
  <div class="block">
    <label>Textbook PDF</label>
    <input type="file" id="tbPdf" accept="application/pdf" />
    <div class="row">
      <input type="number" id="tbStart" placeholder="Start page" min="1" />
      <input type="number" id="tbEnd" placeholder="End page" min="1" />
    </div>
    <button type="button" onclick="extractTextbook()">Extract textbook text</button>
    <div id="tbStatus"></div>
  </div>

  <button id="analyzeBtn" type="button" onclick="analyze()" disabled>
    Analyze and build lesson plan
  </button>

  <div id="output"></div>
</div>

<script>
let outcomesText = "";
let textbookText = "";

function setStatus(elId, msg, ok=true){
  const el = document.getElementById(elId);
  el.innerHTML = `<div class="status ${ok?'ok':'err'}">${msg}</div>`;
}

async function extractRangeFromPdf(file, start, end){
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:buf}).promise;
  const last = pdf.numPages;
  const from = Math.max(1, start||1);
  const to = Math.min(end||from, last);
  let all = "";
  for(let p=from;p<=to;p++){
    const page = await pdf.getPage(p);
    const txt = await page.getTextContent();
    const line = txt.items.map(i=>i.str).join(" ");
    all += `

[Page ${p}]
` + line;
  }
  return all.trim();
}

async function extractOutcomes(){
  const f = document.getElementById("outPdf").files[0];
  if(!f){ setStatus("outStatus","Please choose a PDF.",false); return; }
  const s = Number(document.getElementById("outStart").value||1);
  const e = Number(document.getElementById("outEnd").value||s);
  try{
    setStatus("outStatus",`Reading pages ${s}–${e} …`);
    outcomesText = await extractRangeFromPdf(f,s,e);
    setStatus("outStatus",`OK – extracted ${outcomesText.length} characters from outcomes.`);
    enableAnalyze();
  }catch(err){
    setStatus("outStatus","This PDF seems to be image‑only. Please OCR it once in a desktop tool and upload the searchable version.",false);
  }
}

async function extractTextbook(){
  const f = document.getElementById("tbPdf").files[0];
  if(!f){ setStatus("tbStatus","Please choose a PDF.",false); return; }
  const s = Number(document.getElementById("tbStart").value||1);
  const e = Number(document.getElementById("tbEnd").value||s);
  try{
    setStatus("tbStatus",`Reading pages ${s}–${e} …`);
    textbookText = await extractRangeFromPdf(f,s,e);
    setStatus("tbStatus",`OK – extracted ${textbookText.length} characters from textbook.`);
    enableAnalyze();
  }catch(err){
    setStatus("tbStatus","This PDF seems to be image‑only. Please OCR it once in a desktop tool and upload the searchable version.",false);
  }
}

function enableAnalyze(){
  const key = document.getElementById("apiKey").value.trim();
  document.getElementById("analyzeBtn").disabled = !(key && outcomesText && textbookText);
}

document.getElementById("apiKey").addEventListener("input", enableAnalyze);

async function analyze(){
  const key = document.getElementById("apiKey").value.trim();
  if(!key){ setStatus("output","Enter Groq key first.",false); return; }

  document.getElementById("output").innerHTML =
    '<div class="status ok">Talking to Groq… this can take 10–20 seconds.</div>';

  const prompt = `
You are a curriculum planner.

LEARNING OUTCOMES TEXT:
${outcomesText.slice(0,3500)}

TEXTBOOK LESSON TEXT:
${textbookText.slice(0,6000)}

1. Detect subject and approximate class.
2. Pick 5–8 key learning outcomes.
3. For each, say whether it is covered by the lesson and explain briefly.
4. For each matched outcome, give 3 SMART objectives, 3 activities, 2 assessments.
5. Build a concise lesson plan (duration, materials, step‑by‑step procedure).

Return ONLY valid JSON:

{
  "subject": "string",
  "class": "string",
  "lessonTopic": "string",
  "learningOutcomes": [
    {
      "outcome": "string",
      "matched": true,
      "matchExplanation": "string",
      "smartObjectives": ["string"],
      "activities": ["string"],
      "assessments": ["string"]
    }
  ],
  "lessonPlan": {
    "duration": "string",
    "materials": ["string"],
    "procedure": ["string"]
  }
}
`;

  try{
    const res = await fetch("https://api.groq.com/openai/v1/chat/completions",{
      method:"POST",
      headers:{
        "Authorization":"Bearer "+key,
        "Content-Type":"application/json"
      },
      body:JSON.stringify({
        model:"llama3-70b-8192",
        messages:[{role:"user",content:prompt}],
        temperature:0.2,
        max_tokens:3500
      })
    });
    if(!res.ok) throw new Error("Groq API error: "+res.status);
    const data = await res.json();
    const obj = JSON.parse(data.choices[0].message.content);
    renderResult(obj);
  }catch(err){
    document.getElementById("output").innerHTML =
      `<div class="status err">${err.message}</div>`;
  }
}

function renderResult(d){
  let html = `
  <div class="card">
    <strong>${d.subject}</strong> – Class ${d.class}<br/>
    Topic: ${d.lessonTopic}
  </div>
  <div class="card">
    <strong>Matched learning outcomes</strong>`;
  (d.learningOutcomes||[]).forEach((o,i)=>{
    if(o.matched){
      html += `
      <div class="match">
        <h4>${i+1}. ${o.outcome}</h4>
        <div><strong>Why it matches:</strong> ${o.matchExplanation}</div>
        <div class="obj"><strong>Objectives</strong><br>${(o.smartObjectives||[]).map(x=>"• "+x).join("<br>")}</div>
        <div><strong>Activities:</strong> ${(o.activities||[]).join(" • ")}</div>
        <div><strong>Assessments:</strong> ${(o.assessments||[]).join(" • ")}</div>
      </div>`;
    }
  });
  html += `</div>
  <div class="card">
    <strong>Lesson plan</strong><br/>
    Duration: ${d.lessonPlan.duration}<br/>
    Materials: ${(d.lessonPlan.materials||[]).join(", ")}<br/><br/>
    ${ (d.lessonPlan.procedure||[]).map((s,i)=>`${i+1}. ${s}`).join("<br>") }
  </div>`;
  document.getElementById("output").innerHTML = html;
}
</script>
</body>
</html>
